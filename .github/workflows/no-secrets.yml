name: No Secrets Linter

on:
    pull_request:
        branches:
            - main

jobs:
    scan-secrets:
        name: Scan for Secrets & Sensitive Files
        runs-on: ubuntu-latest
        steps:
            - name: Checkout PR
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # full history so we can diff cleanly

            # â”€â”€ 1. Block committed .env files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            - name: Check for committed .env files
              run: |
                  echo "ğŸ” Scanning for .env files..."
                  # Find any .env, .env.*, .env.local, .env.production, etc.
                  FOUND=$(git diff --name-only origin/main...HEAD | grep -E '(^|/)\.[Ee][Nn][Vv](\.|$)' || true)
                  if [ -n "$FOUND" ]; then
                    echo "âŒ ERROR: Committed .env file(s) detected in this PR:"
                    echo "$FOUND"
                    echo ""
                    echo "Remove these files, rotate any exposed credentials, and add them to .gitignore."
                    exit 1
                  fi
                  echo "âœ… No .env files found."

            # â”€â”€ 2. Scan for secret patterns in changed files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            - name: Scan for secret patterns
              run: |
                  echo "ğŸ” Scanning diff for secret patterns..."

                  # Collect the text of lines added in this PR (+ lines only)
                  git diff origin/main...HEAD -- . \
                    ':(exclude)*.lock' \
                    ':(exclude)package-lock.json' \
                    ':(exclude)yarn.lock' \
                    | grep '^+' \
                    | grep -v '^+++' \
                    > /tmp/added_lines.txt || true

                  FAIL=0

                  check_pattern() {
                    local label="$1"
                    local pattern="$2"
                    local matches
                    matches=$(grep -E "$pattern" /tmp/added_lines.txt || true)
                    if [ -n "$matches" ]; then
                      echo "âŒ [$label] Secret pattern detected:"
                      echo "$matches" | head -20
                      echo ""
                      FAIL=1
                    fi
                  }

                  # Google API / Firebase keys  (AIzaâ€¦)
                  check_pattern "Google API Key"       'AIza[0-9A-Za-z\-_]{35}'

                  # OpenAI / Anthropic / generic sk- keys
                  check_pattern "sk- Secret Key"       'sk-[A-Za-z0-9]{20,}'

                  # Private key headers (PEM blocks)
                  check_pattern "Private Key Block"    '\-\-\-\-\-BEGIN (RSA |EC |OPENSSH |DSA )?PRIVATE KEY\-\-\-\-\-'

                  # AWS
                  check_pattern "AWS Access Key ID"    'AKIA[0-9A-Z]{16}'
                  check_pattern "AWS Secret Key"       'aws_secret_access_key\s*=\s*[A-Za-z0-9/+]{40}'

                  # GitHub personal access tokens (classic and fine-grained)
                  check_pattern "GitHub PAT (classic)"      'ghp_[A-Za-z0-9]{36}'
                  check_pattern "GitHub PAT (fine-grained)" 'github_pat_[A-Za-z0-9_]{82}'

                  # Generic high-entropy assignments (e.g. SECRET=abc123â€¦)
                  check_pattern "Generic Secret Assignment"  '(?i)(secret|password|passwd|api_key|auth_token)\s*[=:]\s*["\x27]?[A-Za-z0-9+/]{16,}["\x27]?'

                  if [ "$FAIL" -eq 1 ]; then
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    echo "âŒ Secret scan FAILED. Remove all flagged values, rotate"
                    echo "   any exposed credentials, and re-push your branch."
                    echo "   If this is a false positive, open a PR to update the"
                    echo "   allowlist in .github/workflows/no-secrets.yml."
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    exit 1
                  fi

                  echo "âœ… No secret patterns detected."

            # â”€â”€ 3. Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            - name: Summary
              if: success()
              run: echo "ğŸ‰ No secrets or .env files found. All clear."
